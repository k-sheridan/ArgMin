version: '3.8'

services:
  # Build the library
  build:
    build:
      context: .
      target: builder
    image: tangent:builder
    volumes:
      - .:/tangent
      - build-cache:/tangent/build
    working_dir: /tangent

  # Run tests
  test:
    build:
      context: .
      target: test
    image: tangent:test
    depends_on:
      - build
    volumes:
      - .:/tangent
      - build-cache:/tangent/build
    command: ["./test/TangentTests", "--gtest_color=yes"]

  # Run benchmarks
  benchmark:
    build:
      context: .
      target: benchmark
    image: tangent:benchmark
    depends_on:
      - build
    volumes:
      - .:/tangent
      - build-cache:/tangent/build
    command: ["./bench/TangentBenchmarks", "--benchmark_repetitions=3"]

  # Development environment
  dev:
    build:
      context: .
      target: dev
    image: tangent:dev
    volumes:
      - .:/tangent
      - build-cache:/tangent/build
    working_dir: /tangent
    stdin_open: true
    tty: true
    command: ["/bin/bash"]

  # Generate documentation
  docs:
    build:
      context: .
      target: docs
    image: tangent:docs
    volumes:
      - .:/tangent
    command: ["sh", "-c", "doxygen Doxyfile && sphinx-build -b html docs docs/_build/html"]

  # Serve documentation locally for preview
  docs-serve:
    build:
      context: .
      target: docs
    image: tangent:docs
    volumes:
      - .:/tangent
    ports:
      - "8000:8000"
    working_dir: /tangent
    command: >
      sh -c "doxygen Doxyfile &&
             sphinx-build -b html docs docs/_build/html &&
             echo 'Documentation available at http://localhost:8000' &&
             python3 -m http.server 8000 --directory docs/_build/html"

  # ASAN tests
  test-asan:
    build:
      context: .
      target: test-asan
    image: tangent:test-asan
    volumes:
      - .:/tangent
      - build-cache-asan:/tangent/build
    command: ["./test/TangentTests", "--gtest_color=yes"]

  # ASAN benchmarks
  benchmark-asan:
    build:
      context: .
      target: benchmark-asan
    image: tangent:benchmark-asan
    volumes:
      - .:/tangent
      - build-cache-asan:/tangent/build
    command: ["./bench/TangentBenchmarks", "--benchmark_repetitions=3"]

  # TSAN tests
  test-tsan:
    build:
      context: .
      target: test-tsan
    image: tangent:test-tsan
    volumes:
      - .:/tangent
      - build-cache-tsan:/tangent/build
    command: ["./test/TangentTests", "--gtest_color=yes"]
    # TSAN requires these security options to disable ASLR
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp=unconfined

  # UBSAN tests
  test-ubsan:
    build:
      context: .
      target: test-ubsan
    image: tangent:test-ubsan
    volumes:
      - .:/tangent
      - build-cache-ubsan:/tangent/build
    command: ["./test/TangentTests", "--gtest_color=yes"]

  # UBSAN benchmarks
  benchmark-ubsan:
    build:
      context: .
      target: benchmark-ubsan
    image: tangent:benchmark-ubsan
    volumes:
      - .:/tangent
      - build-cache-ubsan:/tangent/build
    command: ["./bench/TangentBenchmarks", "--benchmark_repetitions=3"]

volumes:
  build-cache:
  build-cache-asan:
  build-cache-tsan:
  build-cache-ubsan:
